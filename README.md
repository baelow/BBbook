# 北师大羽毛球馆预约程序

## Introduction
使用python语言编写，Cython编译，so 文件是在linux上执行的类文件（类似于windows上的dll文件）。 经过测试可用。
本程序仅可在LINUX上可用，自己没有云服务器的话，建议还是用github自带的ACTION WORKFLOW(见方法二)。

## 使用说明
## 入口函数handle_main.py使用说明
```python
# 通过LINUX命令行调用python

d = sys.argv[1] # d是学号
k = sys.argv[2] # 密码
p = eval(sys.argv[3]) # 场地代号，这里填入两个数字的数组 如  [5988,5977]
t = sys.argv[4] # 预约时间。如果使用GIthub Workflow就是格林尼治时间，否则你就输入当地时间即可（建议注释掉时间的提示 两个print()）。比如学校7:30:00开始预约，那我们这里需要填为23:30:00
s = sys.argv[5] # server酱的key,请自行百度，为了提醒是否预约成功或失败，推送至你的微信。
my_ymq = DDDDOCR_School_BNU_YMQ(d,k,p,t,s)
my_ymq.main_apply_task()
```

### 方法一：
直接下载本仓库文件至本地的linux系统，安装requestments依赖后，执行handle_main.py文件即可。 
note: python须小于等于3.10
1. 首先，cd到文件夹下，然后输入进行测试 （可以删除py文件的时间提醒，那玩意是为workflow准备的）
```
python handle_main.py 学号 密码 场地代号 预约时间 server酱的key
```
2. 建立cron调度命令，cron cd 你的地址;python handle_main.py 学号 密码 场地代号 预约时间 server酱的key >> BBbadmin.log 2>&1

(__温馨提示：设定的最好在目标时间前1-2分钟执行__)

### 方法二：
使用github上自带的github action workflow
1. 点击右上角Fork到自己的仓库
2. Settings==> Security(左下角)==> Secrets ==> Actions ==> 创建自己的Secrets (自己的环境变量，别人看不到的) ==> 
```
建议把变量group设置为 obj_infor,否则还得改yml文件；
设置下面的变量：
YOUR_SECRET_K            （密码）
YOUR_SECRET_NAME         
YOUR_SECRET_PLACE
YOUR_SECRET_SERVERJ
YOUR_SECRET_TIME         （格林尼治时间，写成23:30:00,注意是英文符号）
```
3. 建立触发器（github action自己的定时触发器非常难用，所以自己创建触发器即可）
* 以免费的华为云函数为例 不详细讲了 我看百度上很容易搜到 先自学 https://blog.csdn.net/qq_28778001/article/details/124891438
* 创建python 3.10 ,其他的默认就行啦
* 粘贴触发代码 记得输入你的token(token怎么搞后面说)
```python
# -*- coding:utf-8 -*-
import requests
import json

def run():
    payload = json.dumps({"ref": "main"})
    header = {'Authorization': 'Bearer 你的token',
              "Accept": "application/vnd.github+json"}
    url = 'https://api.github.com/repos/baelow/BBbook/actions/workflows/41743763/dispatches'
    r = requests.post(url = url, headers = header,data=payload)
    print(r)
    print(r.text)

# 云函数入口
def handler(event, context):
    return run()
```
* 设置触发器 Timer 设置好时间 不会的自行百度 Cron 任务完成
4. Token获取
https://docs.github.com/en/rest/reference/actions#create-a-workflow-dispatch-event
也可参考： https://blog.csdn.net/l1937gzjlzy/article/details/117753465

### 测试
1. 输入各种环境变量后，测试github上的工作流是否正常。
* 点击Action 
* 右边有个run workflow 等待看结果
2. 测试华为云函数
部署测试完 是否有报错，更改时间，测试是否运作,—__设定Cron时间应比目标预约时间提前5-10min(github服务器容易拥堵)__

## 场地ID

|             | 羽1 | 羽2 | 羽3 | 羽4 | 羽5  | 羽6  | 羽7  | 羽8  | 小综合1 | 小综合2 | 小综合3 | 小综合4 | 二层东 | 二层西 |
| ----------- | ---- | ---- | ---- | ---- | ----- | ----- | ----- | ----- | ------- | ------- | ------- | ------- | ------ | ------ |
| 8:00-9:00   | 5897 | 5947 | 5997 | 6047 | 35426 | 35476 | 35526 | 35576 | 50419   | 50469   | 50519   | 50569   | 737994 | 738045 |
| 9:00-10:00  | 5895 | 5945 | 5995 | 6045 | 35424 | 35474 | 35524 | 35574 | 50417   | 50467   | 50517   | 50567   | 737992 | 738043 |
| 10:00-11:00 | 5893 | 5943 | 5993 | 6043 | 35422 | 35472 | 35522 | 35572 | 50415   | 50465   | 50515   | 50565   | 737990 | 738041 |
| 11:00-12:00 | 5891 | 5941 | 5991 | 6041 | 35420 | 35470 | 35520 | 35570 | 50413   | 50463   | 50513   | 50563   | 737988 | 738039 |
| 12:00-13:00 | 5889 | 5939 | 5989 | 6039 | 35418 | 35468 | 35518 | 35568 | 50411   | 50461   | 50511   | 50561   | 737986 | 738037 |
| 13:00-14:00 | 5887 | 5937 | 5987 | 6037 | 35416 | 35466 | 35516 | 35566 | 50409   | 50459   | 50509   | 50559   | 737984 | 738035 |
| 14:00-15:00 | 5885 | 5935 | 5985 | 6035 | 35414 | 35464 | 35514 | 35564 | 50407   | 50457   | 50507   | 50557   | 737982 | 738033 |
| 15:00-16:00 | 5883 | 5933 | 5983 | 6033 | 35412 | 35462 | 35512 | 35562 | 50405   | 50455   | 50505   | 50555   | 737980 | 738031 |
| 16:00-17:00 | 5881 | 5931 | 5981 | 6031 | 35410 | 35460 | 35510 | 35560 | 50403   | 50453   | 50503   | 50553   | 737978 | 738029 |
| 17:00-18:00 | 5879 | 5929 | 5979 | 6029 | 35408 | 35458 | 35508 | 35558 | 50401   | 50451   | 50501   | 50551   | 737976 | 738027 |
| 18:00-19:00 | ** | ** | 5977 | 6027 | 35406 | 35456 | 35506 | 35556 | 50399   | 50449   | **   | **   | 737974 | 738025 |
| 19:00-20:00 | ** | ** | 5975 | 6025 | 35404 | 35454 | 35504 | 35554 | 50397   | 50447   | **   | **   | 737972 | 738023 |
| 20:00-21:00 | ** | ** | 5973 | 6023 | 35402 | 35452 | 35502 | 35552 | 50395   | 50445   | **   | **   | 737970 | 738021 |
| 21:00-22:00 | ** | ** | 5971 | 6021 | 35400 | 35450 | 35500 | 35550 | 50393   | 50443   | **   | **   | 737968 | 738019 |


## 结果示例
![](result_example.png)
